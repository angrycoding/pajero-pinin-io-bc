# Доработка штатного БК Pajero Pinin / IO
Хотелось бы сказать спасибо человеку который сделал это: http://carisma-club.su/index.php?showtopic=2770 за то, что он это сделал, а также за то, что все таки **не дал** мне прошивку, благодаря ему, мне пришлось разбираться с этим самому, что несомненно пошло мне только на пользу.

Штатный бортовой комп Pinin/IO состоит из двух плат, процессорной платы и платы дисплея, данный проект описывает, что нужно сделать, чтобы отрезать плату дисплея и бахнуть вместо нее ардуину, которая будет выполнять роль дисплея. То есть считывать то, что должно быть отображено на дисплее (температуру, время, расход, запас топлива, среднюю скорость) и выводить это в последовательный порт, либо куда либо еще, тут уж зависит от вашей фантазии. **Внимание!** Эта хрень работает с дисплейной платой под управлением чипа **LC75874**. С другими чипами может работать а может и не работать, в любом случае это не займет много времени, чтобы переделать все на другой чип, так как я на 100% уверен что другие чипы используют схожий протокол.

Дисплей со всеми включенными сегментами:

![segments](https://github.com/angrycoding/pajero-pinin-io-lcd-slave/blob/master/all_segments.jpg)

Схема подключения ардуины и процессорной платы:

![segments](https://github.com/angrycoding/pajero-pinin-io-lcd-slave/blob/master/circuit.png)

## Протокол взаимодействия процессорной платы и платы дисплея
Все взаимодействие построено на очень похожем на SPI протоколе. То есть у нас есть по сути две линии - CLOCK и DATA, изменение значения CLOCK с 0 на 1, говорит на о том, что на линии DATA можно считать бит данных. Более подробно, протокол описан в документации на чип **LC75874**, там есть еще одна линия, изменение значения на которой дает нам понять о том что конкретно мы  данный момент принимаем (адрес чипа или сами данные), но я на нее забил, поскольку тратить еще один вход ради 8 бит - это непозволительная роскошь, поэтому я просто читаю все от начала и до конца.

Один пакет данных от процессора к дисплею состоит из четырех блоков по 11 байт в каждом (то есть весь пакет - это 44 байта), каждый из блоков начинается с байта адреса чипа = 0x45 (хрен знает зачем он там нужен, наверное для того чтобы можно было на одну линию повесить несколько устройств, я не вникал), затем следует 10 байт описывающих состояние (включено / выключено) каждого сегмента LCD - дисплея. Не все из этих 10 байт - относятся к битам сегментов (см. документацию на **LC75874**), несколько последних бит зарезервировано под какие то спец. нужды (не вникал), главное это последние два бита, для первого блока они будут равны 00, для второго 01, для третьего 10 и для последнего 11. Таким образом имея адрес (0x45), количество байт, и этот двухбитный счетчик блоков, можно читать и проверять инфу идующую на дисплей, больше ничего интересного там нет.

## Подключение ардуины, чтение и вывод данных
На рисунке изображено как подключал ее я, в других модификациях БК, смотрите на то чтобы линии DATA и CLK чипа были подключены к соответствующим SPI линиям Arduino. Для того, чтобы понять какие биты в блоках описанных в предыдущем параграфе, мне пришлось разрезать шлейф идущий на дисплей и подключить ардуину в разрыв шлейфа. Затем я сформировал пакет состоящий из одних единиц, и выдал его дисплею, получив то, что изображено на первой картинке (все сегменты горят). Потом тыркая различные биты я нашел все то, что меня интересовало, а именно: сегменты часов (нужны лишь для тестирования), температуры, пробега расхода и т. д. все это описано в **bits_to_segments.txt**.

## Прошивка
Поскольку данные в блоках от процессора до дисплея представлены в формате "каши", то биты отвечающие за определенные сегменты определенных знакомест дисплея - могут находится в произвольных местах. Чтобы решить проблему канонизации маппинга бит - сегмент, пришлось сделать что то типа виртуального LCD индикатора, который работает на битовой арифметике. Также прикольнуло то, что дотошные японцы в случае когда температура окружающего воздуха больше или меньше предела измерений (-99 .. 99) то вместо неведомой хрени - отображается "HI" и "LO", и затем дисплей переходит в какой то странный режим который сбросить можно только зажиманием кнопки сброса одновременно с включением питания. 

Время 1:52:

![segments](https://github.com/angrycoding/pajero-pinin-io-lcd-slave/blob/master/bc.jpg)

То же, но уже в терминале:

![segments](https://github.com/angrycoding/pajero-pinin-io-lcd-slave/blob/master/terminal.jpg)

## Обработка различных единиц измерения

Штатный бортовой комп позволяет выводить показания в различных единицах измерения (запас топлива: км / миль, средняя скорость: км/ч / миль/ч, расход топлива: км/л, миль/галлон, л/100км), кстати мили - британские. Переключение между режимами отображения проиводится путем одновременного нажатия кнопки сброса (самая левая) и кнопки установки часов (H). Дабы не перекладывать задачу переключения режимов на ардуину, в прошивке я определяю какой конкретно параметр (запас топлива, средняя скорость, расход топлива) и в каких единицах измерения отображается в данный момент и просто перевожу их в км, км/ч и л/100км соответственно. Запас топлива и средняя скорость - всегда округляются до ближайшего целого, расход - округляется до одной цифры после запятой.
